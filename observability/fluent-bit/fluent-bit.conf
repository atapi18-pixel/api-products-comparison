[SERVICE]
    Flush        1
    Daemon       Off
    Log_Level    debug
    Parsers_File parsers.conf
    # Ativar armazenamento em disco para evitar perda de logs quando Loki estiver indisponível
    storage.path  /fluent-bit/storage
    storage.sync  normal
    storage.checksum on
    storage.metrics on

[INPUT]
    Name              tail
    Tag               product-api
    Path              /logs/product-api.log
    Parser            json
    DB                /fluent-bit/storage/flb_kv.db
    Mem_Buf_Limit     10MB
    Read_from_Head    Off
    storage.type      filesystem
    Skip_Long_Lines   On

[FILTER]
    Name              grep
    Match             product-api
    # Manter eventos relevantes: requisições (middleware) e mitigações manuais
    # Inclui linhas cujo campo 'message' contenha 'HTTP request completed' OU 'mitigation executed'
    Regex             message (HTTP request completed|mitigation executed)

[FILTER]
    Name              grep
    Match             product-api
    # Excluir endpoint de métricas (defensivo). Campo 'path' foi adicionado pelo middleware.
    Exclude           path /metrics

[INPUT]
    Name              tail
    Tag               varlogs
    Path              /var/log/*.log
    DB                /fluent-bit/storage/flb_kv_varlogs.db
    Mem_Buf_Limit     5MB
    Read_from_Head    Off

[INPUT]
    Name              tail
    Tag               predictive-monitor
    Path              /logs/predictive-monitor.log
    Parser            json
    DB                /fluent-bit/storage/flb_kv_predictive.db
    Mem_Buf_Limit     5MB
    Read_from_Head    Off
    storage.type      filesystem
    Skip_Long_Lines   On


[OUTPUT]
    Name              loki
    Match             predictive-monitor
    Host              loki
    Port              3100
    labels            job=predictive-monitor,app=products-api,env=local,component=predictive
    line_format       json
    Workers           1

[OUTPUT]
    Name              loki
    Match             product-api
    Host              loki
    Port              3100
    labels            job=product-api,app=products-api,env=local
    line_format       json
    # Habilitar workers paralelos para melhorar throughput em cenários de burst
    Workers           1
