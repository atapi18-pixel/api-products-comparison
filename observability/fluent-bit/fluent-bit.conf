[SERVICE]
    Flush        1
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

[INPUT]
    Name              tail
    Tag               product-api
    Path              /logs/product-api.log
    Parser            json
    DB                /fluent-bit/storage/flb_kv.db
    Mem_Buf_Limit     5MB
    Read_from_Head    Off

[FILTER]
    Name              grep
    Match             product-api
    # Only keep lines where the message is the HTTP request middleware entry
    Regex             message ^HTTP request completed$

[FILTER]
    Name              grep
    Match             product-api
    # Ensure the logged URL contains :8000 (requests served by the app port)
    Regex             url :8000

[FILTER]
    Name              grep
    Match             product-api
    # Exclude the metrics endpoint from being forwarded to Loki
    Exclude           url /metrics

[INPUT]
    Name              tail
    Tag               varlogs
    Path              /var/log/*.log
    DB                /fluent-bit/storage/flb_kv_varlogs.db
    Mem_Buf_Limit     5MB
    Read_from_Head    Off

[OUTPUT]
    Name              loki
    Match             product-api
    Host              loki
    Port              3100
    Labels            job=product-api
