[SERVICE]
    Flush        1
    Daemon       Off
    Log_Level    debug
    Parsers_File parsers.conf
    # Ativar armazenamento em disco para evitar perda de logs quando Loki estiver indisponível
    storage.path  /fluent-bit/storage
    storage.sync  normal
    storage.checksum on
    storage.metrics on

[INPUT]
    Name              tail
    Tag               product-api
    Path              /logs/product-api.log
    Parser            json
    DB                /fluent-bit/storage/flb_kv.db
    Mem_Buf_Limit     10MB
    Read_from_Head    Off
    storage.type      filesystem
    Skip_Long_Lines   On

[FILTER]
    Name              grep
    Match             product-api
    # Manter apenas eventos do middleware principal
    Regex             message ^HTTP request completed$

[FILTER]
    Name              grep
    Match             product-api
    # Excluir endpoint de métricas (defensivo). Campo 'path' foi adicionado pelo middleware.
    Exclude           path /metrics

[INPUT]
    Name              tail
    Tag               varlogs
    Path              /var/log/*.log
    DB                /fluent-bit/storage/flb_kv_varlogs.db
    Mem_Buf_Limit     5MB
    Read_from_Head    Off

[OUTPUT]
    Name              loki
    Match             product-api
    Host              loki
    Port              3100
    labels            job=product-api,app=products-api,env=local
    line_format       json
    # Habilitar workers paralelos para melhorar throughput em cenários de burst
    Workers           1
